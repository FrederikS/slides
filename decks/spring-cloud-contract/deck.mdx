import { Notes, Steps } from "mdx-deck";
import myTheme from "../../src/theme";
import testOk from "./contract_test_ok.png";
import realityFail from "./contract_reality_fail.png";
export const theme = myTheme;

# Spring Cloud Contract

---

## What?

- facilitates contract testing approach
- verifies integration between applications within your system
- integration points between producer and consumer defined by contracts
- supports multiple DSLs for contract definitions (Groovy, Java, Kotlin, YAML)

---

## How?

- generates HTTP/messaging stubs for client/consumer development, doing exactly
  what the actual server/producer implementation does
- generates boilerplate test code, used for verification of the server/producer
  implementation  
- provides a way to publish changes in contracts, immediately visible in both
  sides

---

## Why?

- very fast feedback
- no infrastructure required
- promotes ATDD (acceptance test-driven development) in a microservice-based
  environment

---

## Manually created stubs

<img src={testOk} style={{height: "40vh"}} />
<img src={realityFail} style={{height: "40vh", marginBottom: "1em"}} />

---

# HTTP API Example

---

# Producer-Side

<Notes>

- Could be on consumer-side
- Could be an external repository

</Notes>

---

## Producer Application

```java
@SpringBootApplication
public class ProducerApplication {

  public static void main(String[] args) {
    SpringApplication.run(ProducerApplication.class);
  }

  @Bean
  RouterFunction<ServerResponse> routes(BookHandler bookHandler) {
    return route()
            .POST("/books", accept(APPLICATION_JSON), bookHandler::create)
            .build();
  }
}
```

```java
public class PostBookRequest {

  public final String title;
  public final String description;

  public PostBookRequest(String title, String description) {
    this.title = title;
    this.description = description;
  }

}
```

---

## Contracts

```yaml
# src/test/resources/contracts/post-book-without-title.yml

name: post-book-without-title
description: Adding a book without title should return 400
request:
  method: POST
  url: /books
  headers:
    Content-Type: application/json
  body:
    title:
    description: the book without title
  matchers:
    body:
      - path: $.title
        type: by_null
response:
  status: 400
```

<Notes>

- by convention put into src/test/resources/contracts, but configurable

</Notes>

---

## Configure Maven Plugin

```xml
<!-- pom.xml -->

<build>
  <plugins>
    <plugin>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-contract-maven-plugin</artifactId>
      <version>3.0.2</version>
      <extensions>true</extensions>
      <configuration>
          <testFramework>JUNIT5</testFramework>
          <testMode>WEBTESTCLIENT</testMode>
          <baseClassForTests>com.example.BaseProducerTest</baseClassForTests>
      </configuration>
    </plugin>
  </plugins>
</build>
```

- generates producer tests
- generates stubs for consumer

---

## Generated Producer Test

```java
@SpringBootTest(webEnvironment = RANDOM_PORT)
class BaseProducerTest {

    @Autowired
    private ApplicationContext context;

    @BeforeEach
    void setUp() {
        RestAssuredWebTestClient.applicationContextSetup(context);
    }

}
```

```java
// generated by plugin
public class BooksTest extends BaseProducerTest {

  @Test
  public void validate_post_book_without_title() throws Exception {
    // given:
    WebTestClientRequestSpecification request = given()
        .header("Content-Type", "application/json")
        .body("{\"title\":null}");

    // when:
    WebTestClientResponse response = given().spec(request)
        .post("/books");

    // then:
    assertThat(response.statusCode()).isEqualTo(400);
  }

}
```

---

## Generated Stub

```json
{
  "id": "0694af37-d0c4-4357-b1c9-936dbc773cc0",
  "request": {
    "url": "/books",
    "method": "POST",
    "headers": {
      "Content-Type": {
        "equalTo": "application/json"
      }
    },
    "bodyPatterns": [
      {
        "matchesJsonPath": "$[?(@.['title'] == null)]"
      }
    ]
  },
  "response": {
    "status": 400,
    "transformers": ["response-template", "spring-cloud-contract"]
  },
  "uuid": "0694af37-d0c4-4357-b1c9-936dbc773cc0"
}
```

<Notes>

- uses wiremock in the background

</Notes>

---

# Consumer-Side

---

## Book API Client

```java
@Component
public class BookApiClient {

  private final WebClient client;

  @Autowired
  public BookApiClient(WebClient client) {
    this.client = client;
  }

  public Mono<BookResponse> createBook(PostBookRequest request) {
    return client.post().uri("/books")
                 .contentType(APPLICATION_JSON)
                 .bodyValue(request)
                 .retrieve()
                 .bodyToMono(BookResponse.class);
  }

}
```

---

## Integration Test

```xml
<!-- pom.xml -->

<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-contract-stub-runner</artifactId>
  <scope>test</scope>
</dependency>
```

```java
@SpringBootTest(webEnvironment = NONE, properties = {
        "stubrunner-port=${stubrunner.runningstubs.producer.port}",
        "web.client.base-url=http://localhost:${stubrunner-port:8081}"
})
@AutoConfigureStubRunner(
        stubsMode = LOCAL,
        ids = "com.example:producer:0.0.1-SNAPSHOT:stubs"
)
class BookApiClientTest {

  @Autowired private BookApiClient client;

  @Test
  void createBookWithNullTitleShouldReturnBadRequest() {
    var bookRequest = new PostBookRequest(null, "description");
    StepVerifier.create(client.createBook(bookRequest))
                .verifyError(BadRequest.class);
  }

}
```

<Notes>

- LOCAL -> checking for stubs in local maven repository
- CLASSPATH -> checking for stubs in classpath
- REMOTE -> checking for stubs in a remote repository
- "ivy" notation ([groupId]:artifactId:[version]:[classifier][:port])
- when no port is specified, a random port is assigned, accessable through
  property

</Notes>

---

## Usings stubs for local development

```xml
<!-- pom.xml -->

<plugin>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-contract-maven-plugin</artifactId>
  <version>3.0.2</version>
  <extensions>true</extensions>
  <configuration>
    <skip>true</skip>
    <contractsMode>LOCAL</contractsMode>
    <stubs>com.example:producer:0.0.1-SNAPSHOT:stubs:8080</stubs>
  </configuration>
</plugin>

<!-- Usage: mvn spring-cloud-contract:run -->
```

```yaml
# docker-compose.yml

version: "3.8"

services:
  producer-api-stub:
    image: springcloud/spring-cloud-contract-stub-runner:3.0.2
    environment:
      STUBRUNNER_IDS: "com.example:producer:0.0.1-SNAPSHOT:stubs:8080"
      STUBRUNNER_STUBS_MODE: LOCAL
    ports:
      - "8080:8080"
    volumes:
      - ~/.m2:/root/.m2
```

---

# Thanks!

## Questions?

---

## Links

- https://cloud.spring.io/spring-cloud-contract/reference/html/index.html
- https://cloud-samples.spring.io/spring-cloud-contract-samples/tutorials/contracts_on_the_producer_side.html
- https://www.infoq.com/articles/contract-testing-spring-cloud-contract/
- https://github.com/FrederikS/spring-cloud-contract-samples

---